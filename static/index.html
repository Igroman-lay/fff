<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏦 Виртуальный Банк</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 450px;
            width: 100%;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

            header h1 {
                font-size: 2.2em;
                margin-bottom: 10px;
            }

            header p {
                opacity: 0.9;
                font-size: 1.1em;
            }

        .form-panel, .bank-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

            .form-panel:not(.active) {
                display: none;
            }

        .hidden {
            display: none !important;
        }

        .form-panel h2, .transfer-form h3 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

            input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

            button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

        .balance-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

            .balance-card h2 {
                margin-bottom: 15px;
            }

        .balance {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn-small {
            width: auto;
            padding: 10px 25px;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .transfer-form {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-danger {
            flex: 1;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

            .btn-danger:hover {
                box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
            }

        .hint {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .server-info {
            text-align: center;
            color: white;
            font-size: 0.9em;
            margin-top: 20px;
            opacity: 0.8;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            header h1 {
                font-size: 1.8em;
            }

            .balance {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🏦 Виртуальный Банк</h1>
            <p>Виртуальные деньги • Переводы • 2FA по email</p>
            <div class="server-info" id="server-info">
                Подключение к серверу...
            </div>
        </header>

        <div class="error-message" id="error-message"></div>

        <!-- Форма регистрации -->
        <div id="register-form" class="form-panel">
            <h2>📝 Регистрация</h2>
            <input id="reg-login" placeholder="Логин (3-20 символов)" maxlength="20">
            <input id="reg-password" type="password" placeholder="Пароль (минимум 6 символов)">
            <input id="reg-email" type="email" placeholder="Email" value="genaklimov2005@gmail.com">
            <button onclick="register()">Создать аккаунт</button>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="switchToLogin()" style="background: #6c757d;">Войти в аккаунт</button>
            </div>
        </div>

        <!-- Форма входа -->
        <div id="login-form" class="form-panel">
            <h2>🔐 Вход</h2>
            <input id="login-login" placeholder="Логин">
            <input id="login-password" type="password" placeholder="Пароль">
            <button onclick="login()">Войти</button>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="switchToRegister()" style="background: #6c757d;">Назад к регистрации</button>
            </div>
        </div>

        <!-- Форма подтверждения кода -->
        <div id="code-form" class="form-panel">
            <h2>📧 Код из письма</h2>
            <input id="code" placeholder="Введите 6 цифр" maxlength="6" inputmode="numeric">
            <button onclick="verifyCode()">Подтвердить</button>
            <p class="hint">Проверьте почту (и папку спам)! Код действителен 5 минут.</p>
        </div>

        <!-- Основной интерфейс банка -->
        <div id="bank-panel" class="bank-panel">
            <div class="balance-card">
                <h2>💰 Баланс</h2>
                <div id="balance" class="balance">0 ₽</div>
                <button onclick="refreshBalance()" class="btn-small">Обновить</button>
            </div>

            <div class="transfer-form">
                <h3>💸 Перевод</h3>
                <input id="to-login" placeholder="Логин получателя">
                <input id="amount" type="number" placeholder="Сумма" min="0.01" step="0.01">
                <button onclick="transfer()">Перевести</button>
            </div>

            <div class="actions">
                <button onclick="logout()" class="btn-danger">Выход</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname.includes('localhost') 
    	? 'http://localhost:10000/' 
    	: 'https://ваш-проект.onrender.com/';

        // Инициализация - проверяем соединение при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
        hideAllPanels();
        document.getElementById('register-form').style.display = 'block';
        await checkServerConnection();
        });

        // Проверка соединения с сервером
        async function checkServerConnection() {
        const serverInfo = document.getElementById('server-info');
        try {
        const response = await fetch(API_BASE + 'health', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
        timeout: 5000
        });

        if (response.ok) {
        const data = await response.json();
        serverInfo.innerHTML = `✅ Сервер: ${data.status}, База данных: ${data.database}`;
        } else {
        serverInfo.innerHTML = '⚠️ Сервер недоступен. Проверьте URL API.';
        showError('Сервер недоступен. Проверьте подключение к интернету и URL API.');
        }
        } catch (error) {
        serverInfo.innerHTML = '❌ Ошибка подключения к серверу';
        showError(`Не удалось подключиться к серверу: ${API_BASE}<br>Проверьте:<br>1. Сервер запущен на Render<br>2. Правильный URL<br>3. Нет блокировок CORS`);
        }
        }

        // Функции переключения между формами
        function switchToLogin() {
        hideAllPanels();
        document.getElementById('login-form').style.display = 'block';
        hideError();
        }

        function switchToRegister() {
        hideAllPanels();
        document.getElementById('register-form').style.display = 'block';
        hideError();
        }

        function hideAllPanels() {
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('code-form').style.display = 'none';
        document.getElementById('bank-panel').style.display = 'none';
        }

        // Функции отображения ошибок
        function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = message;
        errorDiv.style.display = 'block';
        }

        function hideError() {
        document.getElementById('error-message').style.display = 'none';
        }

        // Функция для проверки заполненности полей
        function validateFields(fields) {
        for (const [fieldId, fieldName] of fields) {
        const field = document.getElementById(fieldId);
        if (!field || !field.value.trim()) {
        showError(`❌ Пожалуйста, заполните поле: ${fieldName}`);
        if (field) field.focus();
        return false;
        }
        }
        return true;
        }

        // API функции
        async function apiPost(endpoint, data) {
        try {
        const response = await fetch(API_BASE + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
        });

        if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
        } catch (error) {
        console.error('API Error:', error);
        throw error;
        }
        }

        // Регистрация
        async function register() {
        const fields = [
        ['reg-login', 'Логин'],
        ['reg-password', 'Пароль'],
        ['reg-email', 'Email']
        ];

        if (!validateFields(fields)) return;

        const data = {
        login: document.getElementById('reg-login').value.trim(),
        password: document.getElementById('reg-password').value.trim(),
        email: document.getElementById('reg-email').value.trim()
        };

        // Валидация
        if (data.login.length < 3) {
        showError('Логин должен быть не менее 3 символов');
        return;
        }
        if (data.password.length < 6) {
        showError('Пароль должен быть не менее 6 символов');
        return;
        }

        showLoading();
        try {
        const json = await apiPost('register', data);
        if (json.success) {
        alert('✅ Аккаунт создан! Теперь войдите.');
        switchToLogin();
        } else {
        showError('❌ ' + (json.error || 'Ошибка регистрации'));
        }
        } catch (error) {
        showError('❌ Ошибка соединения с сервером. Проверьте URL и подключение к интернету.');
        } finally {
        hideLoading();
        }
        }

        // Вход
        async function login() {
        const fields = [
        ['login-login', 'Логин'],
        ['login-password', 'Пароль']
        ];

        if (!validateFields(fields)) return;

        const data = {
        login: document.getElementById('login-login').value.trim(),
        password: document.getElementById('login-password').value.trim()
        };

        showLoading();
        try {
        const json = await apiPost('login', data);
        if (json.success) {
        if (json.await_code) {
        hideAllPanels();
        document.getElementById('code-form').style.display = 'block';
        document.getElementById('code').focus();
        hideError();
        } else {
        hideAllPanels();
        document.getElementById('bank-panel').style.display = 'block';
        refreshBalance();
        hideError();
        }
        } else {
        showError('❌ ' + (json.error || 'Неверный логин или пароль'));
        }
        } catch (error) {
        showError('❌ Ошибка соединения с сервером. Проверьте URL: ' + API_BASE);
        } finally {
        hideLoading();
        }
        }

        // Подтверждение кода
        async function verifyCode() {
        const code = document.getElementById('code').value.trim();
        if (!code || code.length !== 6) {
        showError('❌ Введите 6-значный код');
        document.getElementById('code').focus();
        return;
        }

        showLoading();
        try {
        const json = await apiPost('verify_code', { code: code });
        if (json.success) {
        hideAllPanels();
        document.getElementById('bank-panel').style.display = 'block';
        refreshBalance();
        hideError();
        } else {
        showError('❌ ' + (json.error || 'Неверный или просроченный код'));
        }
        } catch (error) {
        showError('❌ Ошибка соединения с сервером');
        } finally {
        hideLoading();
        }
        }

        // Обновление баланса
        async function refreshBalance() {
        try {
        const response = await fetch(API_BASE + 'balance', {
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
        });

        if (response.ok) {
        const json = await response.json();
        if (json.balance !== undefined) {
        document.getElementById('balance').textContent = json.balance.toFixed(2) + ' ₽';
        } else if (json.error) {
        showError('❌ ' + json.error);
        logout();
        }
        } else if (response.status === 401) {
        showError('❌ Сессия истекла. Войдите снова.');
        logout();
        }
        } catch (error) {
        console.error('Ошибка при обновлении баланса:', error);
        showError('❌ Не удалось получить баланс');
        }
        }

        // Перевод денег
        async function transfer() {
        const fields = [
        ['to-login', 'Логин получателя'],
        ['amount', 'Сумма']
        ];

        if (!validateFields(fields)) return;

        const amount = parseFloat(document.getElementById('amount').value);
        if (amount <= 0) {
        showError('❌ Сумма должна быть больше 0');
        return;
        }

        const data = {
        to_login: document.getElementById('to-login').value.trim(),
        amount: amount
        };

        showLoading();
        try {
        const json = await apiPost('transfer', data);
        if (json.success) {
        alert('✅ Перевод успешно выполнен!');
        document.getElementById('to-login').value = '';
        document.getElementById('amount').value = '';
        refreshBalance();
        hideError();
        } else {
        showError('❌ ' + (json.error || 'Ошибка перевода'));
        }
        } catch (error) {
        showError('❌ Ошибка соединения с сервером');
        } finally {
        hideLoading();
        }
        }

        // Выход
        async function logout() {
        try {
        await fetch(API_BASE + 'logout');
        location.reload();
        } catch (error) {
        location.reload();
        }
        }

        // Управление состоянием кнопок
        function showLoading() {
        document.querySelectorAll('button').forEach(b => b.disabled = true);
        }

        function hideLoading() {
        document.querySelectorAll('button').forEach(b => b.disabled = false);
        }
    </script>
</body>
</html>